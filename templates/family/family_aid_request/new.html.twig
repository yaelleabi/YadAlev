{% extends 'base.html.twig' %}
{% block title %}Nouvelle demande d’aide - Yad Alev{% endblock %}

{% block body %}
<div class="d-flex flex-column justify-content-center align-items-center min-vh-100 bg-page">
  <!-- Flèche retour -->
  <a href="{{ path('app_family_home') }}" class="back-arrow" onclick="return confirmBack(event);">
    <i class="fas fa-arrow-left"></i>
  </a>

  
  <!-- Logo et en-tête -->
  <div class="text-center mb-4">
    <a href="{{ path('app_family_home') }}">
      <img src="{{ asset('images/LOGO.PNG') }}" alt="Logo Yad Alev" class="logo">
    </a>
    <h2 class="text-primary fw-bold mt-2">Nouvelle demande d’aide</h2>
    <p class="text-muted mb-0">Complétez chaque étape puis validez à la fin.</p>
  </div>

  <!-- Carte du formulaire -->
  <div class="card wizard-card shadow-sm p-4" style="max-width: 920px; width:100%;">
    
    <!-- Barre d’étapes -->
    <ul class="nav nav-pills justify-content-between flex-wrap gap-2 mb-4 wizard-tabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" id="step1-tab" data-step="0">1. Identité</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="step2-tab" data-step="1" tabindex="-1">2. Famille et logement</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="step3-tab" data-step="2" tabindex="-1">3. Finances</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="step4-tab" data-step="3" tabindex="-1">4. Demande</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="step5-tab" data-step="4" tabindex="-1">5. Documents</button></li>
    </ul>

    <div class="progress mb-4" style="height:8px;">
      <div id="wizardProgress" class="progress-bar" style="width:20%;"></div>
    </div>

    {{ form_start(form, {
      attr: {
        id: 'aidrequest-form',
        'data-turbo': 'false',
        onkeydown: "return event.key!='Enter';",
        novalidate: 'novalidate'
      }
    }) }}

      <!-- Étapes du formulaire -->
      <div class="tab-content">
        <div class="tab-pane fade show active" id="step1">
          <h5 class="text-secondary mb-3">Étape 1 — Informations personnelles</h5>
          <div class="row g-3">
            <div class="col-md-6">{{ form_row(form.lastName) }}</div>
            <div class="col-md-6">{{ form_row(form.firstName) }}</div>
            <div class="col-md-6">{{ form_row(form.dateOfBirth) }}</div>
            <div class="col-md-6">{{ form_row(form.phoneNumber) }}</div>
            <div class="col-12">{{ form_row(form.email) }}</div>
          </div>

          {% if form.adress is defined %}
          <div class="border rounded p-3 mt-4">
            <h6 class="text-primary mb-3">Adresse complète</h6>
            <div class="row g-3">

              <div class="col-md-4">
                {{ form_row(form.adress.streetNumber) }}
              </div>

              <div class="col-md-8">
                {{ form_row(form.adress.street) }}
              </div>

              <div class="col-md-4">
                {{ form_row(form.adress.postalCode) }}
              </div>

              <div class="col-md-8">
                {{ form_row(form.adress.city) }}
                <div id="city-wrapper"></div>
              </div>

            </div>
          </div>
          {% endif %}

          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-primary" data-next>Suivant</button>
          </div>
        </div>

        <div class="tab-pane fade" id="step2">
          <h5 class="text-secondary mb-3">Étape 2 — Situation familiale et logement</h5>
          <div class="row g-3">
            <div class="col-md-6">{{ form_row(form.maritalStatus) }}</div>
            <div class="col-md-6">{{ form_row(form.dependantsCount) }}</div>
            <div class="col-md-6">{{ form_row(form.housingStatus) }}</div>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" data-prev>Précédent</button>
            <button type="button" class="btn btn-primary" data-next>Suivant</button>
          </div>
        </div>

        <div class="tab-pane fade" id="step3">
          <h5 class="text-secondary mb-3">Étape 3 — Informations financières</h5>
          <div class="row g-3">
            <div class="col-md-6">{{ form_row(form.employmentStatus) }}</div>
            <div class="col-md-6">{{ form_row(form.monthlyIncome) }}</div>
            <div class="col-md-6">{{ form_row(form.spouseEmploymentStatus) }}</div>
            <div class="col-md-6">{{ form_row(form.spouseMonthlyIncome) }}</div>
            <div class="col-md-6">{{ form_row(form.familyAllowanceAmount) }}</div>
            <div class="col-md-6">{{ form_row(form.alimonyAmount) }}</div>
            <div class="col-md-6">{{ form_row(form.rentAmountNetAide) }}</div>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" data-prev>Précédent</button>
            <button type="button" class="btn btn-primary" data-next>Suivant</button>
          </div>
        </div>

        <div class="tab-pane fade" id="step4">
          <h5 class="text-secondary mb-3">Étape 4 — Détails de la demande</h5>
          <div class="row g-3">
            <div class="col-md-6">{{ form_row(form.requestType) }}</div>
            <div class="col-md-6">{{ form_row(form.requestDuration) }}</div>
            <div class="col-12">{{ form_row(form.otherRequestDuration) }}</div>
            <div class="col-md-6">{{ form_row(form.urgencyLevel) }}</div>
            <div class="col-12">{{ form_row(form.requestReason) }}</div>
            <div class="col-12">{{ form_row(form.urgencyExplanation) }}</div>
            <div class="col-12">{{ form_row(form.otherNeed) }}</div>
            <div class="col-12">{{ form_row(form.otherComment) }}</div>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" data-prev>Précédent</button>
            <button type="button" class="btn btn-primary" data-next>Suivant</button>
          </div>
        </div>

        <div class="tab-pane fade" id="step5">
          <h5 class="text-secondary mb-3">Étape 5 — Documents et consentement</h5>
          <div class="row g-3">
            <div class="col-12">{{ form_row(form.identityProofFilename) }}</div>
            <div class="col-12">{{ form_row(form.incomeProofFilename) }}</div>
            <div class="col-12">{{ form_row(form.taxNoticeFilename) }}</div>
            <div class="col-12">{{ form_row(form.quittanceLoyer) }}</div>
            <div class="col-12">{{ form_row(form.avisCharge) }}</div>
            <div class="col-12">{{ form_row(form.taxeFonciere) }}</div>
            <div class="col-12">{{ form_row(form.fraisScolarite) }}</div>
            <div class="col-12">{{ form_row(form.attestationCaf) }}</div>
            <div class="col-12">{{ form_row(form.otherDocumentFilename) }}</div>
            <div class="col-12">
              {{ form_row(form.privacyConsent) }}
              <small class="form-text text-muted">
                En cochant cette case, vous acceptez notre 
                <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">politique de confidentialité</a>.
              </small>

           

          </div>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" data-prev>Précédent</button>
            <button type="submit" class="btn btn-success">Envoyer la demande</button>
          </div>
        </div>
      </div>

    {{ form_end(form) }}

    <p class="text-muted mt-4 small text-center">
      <span class="text-danger">*</span> Les champs obligatoires sont marqués d’une étoile.
    </p>
  </div>
</div>
<!-- Modal – Politique de confidentialité -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="privacyModalLabel">Termes & Conditions – Politique de confidentialité</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" style="line-height:1.6">

        <p><strong>L'Association Yad Alev</strong> s'engage à protéger la confidentialité des informations personnelles collectées via ce formulaire de demande d'aide. 
        Les informations fournies seront utilisées uniquement dans le but de traiter et de répondre à votre demande d'aide
         (ou de la compléter par toutes autres aides que l'association jugera utile de vous proposer).
        </p>

        <h6 class="mt-3">Collecte et utilisation des informations</h6>
        <p> Les informations personnelles collectées, telles que le nom, l'adresse et les coordonnées, ne seront utilisées que dans le cadre du traitement de votre demande d'aide. 
        Ces informations pourront être traitées par Yad Alev, ses membres & bénévoles, 
        mais également par nos partenaires associatifs dans le cadre d'un accompagnement social plus complet.
        Les détails financiers fournis seront traités de manière confidentielle et ne seront utilisés que pour évaluer votre admissibilité à l'aide demandée ou toutes autres aides que Yad Alev jugera utile de vous proposer. 
        Aucune information personnelle ne sera partagée, louée ou vendue à des tiers non mentionnés (hors partenaires associatifs) sans votre consentement préalable, sauf si cela est requis par la loi.</p>

        <h6 class="mt-3">Sécurité des données</h6>
        <p>Nous mettons en œuvre des mesures de sécurité appropriées pour protéger vos informations personnelles contre tout accès non autorisé, toute divulgation ou toute altération. Seuls les membres autorisés de l'Association Yad Alev 
        (ou les partenaires associatifs) auront accès à vos informations personnelles, et ce, dans le seul but de traiter votre demande d'aide.</p>

        <h6 class="mt-3">Conservation</h6>
        <p>Vos informations personnelles seront conservées aussi longtemps que nécessaire pour atteindre les objectifs pour lesquels elles ont été collectées
        , sauf si une période de conservation plus longue est requise par la loi.</p>

        <h6 class="mt-3">Droits</h6>
        <p>Vous pouvez demander accès, modification ou suppression de vos données :</p>
        <p>Vous avez le droit de demander l'accès, la rectification ou la suppression de vos informations personnelles. 
        Pour exercer ces droits ou pour toute question concernant notre politique de confidentialité, veuillez nous contacter à l'adresse indiquée ci-dessous.</p>

        <h6 class="mt-3">Contact</h6>
        <p>Pour toute question ou préoccupation concernant notre politique de confidentialité ou
         pour exercer vos droits sur vos données personnelles, veuillez nous contacter à l'adresse suivante : yadalev@outlook.fr </p>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>

    </div>
  </div>
</div>

<style>
input:disabled {
  background-color: #f1f3f5 !important;
  color: #6c757d !important;
  cursor: not-allowed;
}


.bg-page {
  overflow-x: hidden;
}
.logo {
  width: 120px;
  height: auto;
  margin-bottom: 1rem;
  opacity: 0;
  animation: fadeLogo 1.2s ease-out forwards;
  filter: drop-shadow(0 3px 3px rgba(0, 0, 0, 0.1));
}
@keyframes fadeLogo {
  0% { opacity: 0; transform: scale(0.98) translateY(-8px); }
  100% { opacity: 1; transform: scale(1) translateY(0); }
}
.disabled-style {
    background-color: #e9ecef !important; /* gris Bootstrap */
    color: #6c757d !important;
    cursor: not-allowed;
}

.card {
  border: 1px solid #e2e8f0;
  border-radius: 1rem;
  box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 16px 50px rgba(0, 0, 0, 0.15);
}
.wizard-tabs .nav-link {
  border-radius: 999px;
  padding: .5rem 1rem;
  transition: all 0.3s ease;
}
.wizard-tabs .nav-link.active {
  background-color: #0d6efd;
}
.wizard-tabs .nav-link.disabled {
  pointer-events: none;
  opacity: .6;
}
.form-control, .form-select {
  border-radius: .5rem;
  transition: all 0.3s ease;
}
.form-control:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
}
.btn {
  border-radius: .6rem;
  transition: all 0.3s ease;
}
.btn:hover {
  transform: translateY(-1px);
}
.back-arrow {
    position: absolute;
    top: 25px;
    left: 25px;
    font-size: 1.6rem;
    color: #0d6efd;
    background: white;
    padding: 8px 12px;
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transition: 0.25s ease;
    z-index: 2000;
    text-decoration: none;
}

.back-arrow:hover {
    transform: translateX(-4px);
    color: #084298;
}

</style>



<script>
// ⚠️ Confirme avant de quitter le formulaire en cours
function confirmBack(event) {
    const answer = confirm("⚠️ Attention : vos informations non enregistrées seront perdues.\n\nVoulez-vous vraiment revenir à la page Famille ?");
    if (!answer) {
        event.preventDefault();
        return false;
    }
    return true;
}
// ⭐ Ajoute automatiquement une étoile rouge sur les labels des champs obligatoires
function addRequiredStars() {
  document.querySelectorAll('label[for]').forEach(label => {
    const fieldId = label.getAttribute('for');
    const field = document.getElementById(fieldId);

    const isRequired =
      (field && (field.required || field.getAttribute('aria-required') === 'true')) ||
      label.closest('.form-group, .col-md-6, .col-12')?.querySelector('.required');

    if (isRequired && !label.querySelector('.text-danger')) {
      label.innerHTML = label.innerHTML + ' <span class="text-danger">*</span>';
    }
  });
}

// Pour le premier chargement classique
document.addEventListener('DOMContentLoaded', addRequiredStars);

// Pour les chargements Turbo
document.addEventListener('turbo:load', addRequiredStars);

(function() {
  const tabs = [
    {btn: document.getElementById('step1-tab'), pane: document.getElementById('step1')},
    {btn: document.getElementById('step2-tab'), pane: document.getElementById('step2')},
    {btn: document.getElementById('step3-tab'), pane: document.getElementById('step3')},
    {btn: document.getElementById('step4-tab'), pane: document.getElementById('step4')},
    {btn: document.getElementById('step5-tab'), pane: document.getElementById('step5')},
  ];

  const progress = document.getElementById('wizardProgress');
  const formEl = document.getElementById('aidrequest-form');
  let current = 0;
  activate(0);

  document.querySelectorAll('[data-next]').forEach(b => b.addEventListener('click', () => step(1)));
  document.querySelectorAll('[data-prev]').forEach(b => b.addEventListener('click', () => step(-1)));

  formEl.addEventListener('submit', (e) => {
    if (!validateStep(current)) {
      e.preventDefault();
      e.stopPropagation();
      activate(current);
      return;
    }

    if (current === 4) {
      const privacyCheckbox = document.querySelector('input[id$="_privacyConsent"]');
      if (privacyCheckbox && !privacyCheckbox.checked) {
        e.preventDefault();
        e.stopPropagation();
        const container = privacyCheckbox.closest('.form-check') 
          || privacyCheckbox.closest('.form-group, .col-12') 
          || privacyCheckbox.parentElement;
        showError(privacyCheckbox, container, 'Vous devez accepter le traitement de vos données personnelles pour continuer.');
        activate(4);
      }
    }
  });

  function step(delta) {
    if (delta > 0 && !validateStep(current)) return;
    const target = Math.min(Math.max(current + delta, 0), tabs.length - 1);
    activate(target);
  }

  function activate(index) {
    tabs.forEach((t, i) => {
      const isActive = i === index;
      t.pane.classList.toggle('show', isActive);
      t.pane.classList.toggle('active', isActive);
      t.btn.classList.toggle('active', isActive);
      t.btn.classList.toggle('disabled', i > index);
    });
    current = index;
    progress.style.width = ((index + 1) / tabs.length) * 100 + '%';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function validateStep(stepIndex) {
    const pane = tabs[stepIndex].pane;
    const inputs = pane.querySelectorAll('input, select, textarea');
    let valid = true;

    inputs.forEach(input => {
      const container = input.parentElement;
      const oldError = container.querySelector('.invalid-feedback');
      if (oldError) oldError.remove();
      input.classList.remove('is-invalid');

      const name = input.name.toLowerCase();
      const isCheckbox = input.type === 'checkbox';
      const isFile = input.type === 'file';
      const isSelect = input.tagName === 'SELECT';
      const isTextarea = input.tagName === 'TEXTAREA';
      const isInput = input.tagName === 'INPUT';

      const isRequired =
        input.hasAttribute('required') ||
        input.getAttribute('aria-required') === 'true' ||
        (input.closest('.form-group, .col-md-6, .col-12')?.querySelector('label')?.textContent?.includes('*'));

      let isEmpty = false;

      if (isCheckbox) isEmpty = !input.checked;
      else if (isFile) isEmpty = input.files.length === 0;
      else if (isSelect) isEmpty = !input.value || input.value === '';
      else if (isTextarea || isInput) isEmpty = !input.value.trim();

      if (isRequired && isEmpty) {
        showError(input, container, 'Ce champ est obligatoire.');
        valid = false;
      }

      if (/(lastname|firstname)/.test(name) && input.value.trim()) {
        const value = input.value.trim();
        if (!/^[A-Za-zÀ-ÿ\s]+$/.test(value)) {
          showError(input, container, 'Seules les lettres et espaces sont autorisées.');
          valid = false;
        } else if (value.length < 2) {
          showError(input, container, 'Ce champ doit contenir au moins 2 lettres.');
          valid = false;
        }
      }

      if (input.id.endsWith('adress_street')) {
        const value = input.value.trim();
        if (value && !/^[A-Za-zÀ-ÿ0-9\s]+$/.test(value)) {
          showError(input, container, 'Seules les lettres, chiffres et espaces sont autorisés.');
          valid = false;
        } else if (value && value.length < 2) {
          showError(input, container, 'Ce champ doit contenir au moins 2 caractères.');
          valid = false;
        }
      }

      if (name.includes('streetnumber') && input.value.trim() && !/^\d+$/.test(input.value.trim())) {
        showError(input, container, 'Uniquement des chiffres sont autorisés.');
        valid = false;
      }

      if (name.includes('phonenumber') && input.value.trim() && !/^\+?\d{9,15}$/.test(input.value.trim())) {
        showError(input, container, 'Le numéro de téléphone doit comporter entre 9 et 15 chiffres.');
        valid = false;
      }

      if (name.includes('postalcode') && input.value.trim() && !/^\d{5}$/.test(input.value.trim())) {
        showError(input, container, 'Le code postal doit comporter exactement 5 chiffres.');
        valid = false;
      }

      if (
        name.includes('dependantscount') || 
        name.includes('monthlyincome') || 
        name.includes('spousemonthlyincome') || 
        name.includes('familyallowanceamount') || 
        name.includes('alimonyamount') || 
        name.includes('rentamountnetaide')
      ) {
        const value = input.value.trim();
        if (value && !/^\d+([.,]\d{1,2})?$/.test(value)) {
          showError(input, container, 'Uniquement des chiffres sont autorisés.');
          valid = false;
        }
      }

      if (name.includes('email') && input.value.trim()) {
        const value = input.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
        if (!emailRegex.test(value)) {
          showError(input, container, 'Veuillez entrer une adresse e-mail valide.');
          valid = false;
        }
      }

      if (name.includes('dateofbirth') && input.value.trim()) {
        const value = input.value.trim();
        const inputDate = new Date(value);
        const today = new Date();
        inputDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        if (isNaN(inputDate.getTime())) {
          showError(input, container, 'Date invalide.');
          valid = false;
        } else if (inputDate >= today) {
          showError(input, container, 'La date doit être antérieure à aujourd’hui.');
          valid = false;
        } else if (inputDate.getFullYear() < 1900) {
          showError(input, container, 'Date invalide.');
          valid = false;
        }
      }
    });

    if (stepIndex === 4) {
      const privacyCheckbox = document.querySelector('input[id$="_privacyConsent"]');
      if (privacyCheckbox && !privacyCheckbox.checked) {
        const container = privacyCheckbox.closest('.form-check') 
          || privacyCheckbox.closest('.form-group, .col-12') 
          || privacyCheckbox.parentElement;
        showError(privacyCheckbox, container, 'Vous devez accepter le traitement de vos données personnelles pour continuer.');
        valid = false;
      }
    }

    if (!valid) window.scrollTo({ top: 0, behavior: 'smooth' });
    return valid;
  }

  function showError(input, container, message) {
    input.classList.add('is-invalid');
    const error = document.createElement('div');
    error.className = 'invalid-feedback';
    error.textContent = message;

    if (input.type === 'checkbox') {
      const label = container.querySelector('label');
      if (label) label.insertAdjacentElement('afterend', error);
      else container.appendChild(error);
      error.style.display = 'block';
    } else {
      container.appendChild(error);
    }
  }
})();
function initAddressApi() {
        const cpField  = document.getElementById('{{ form.adress.postalCode.vars.id }}');
        const cityField = document.getElementById('{{ form.adress.city.vars.id }}');
        const cityWrapper = document.getElementById('city-wrapper');

        // Sécurité : si les champs ne sont pas sur la page, on arrête tout de suite
        if (!cpField || !cityField || !cityWrapper) return;

        // On supprime les anciens écouteurs potentiels pour éviter les doublons (bonne pratique)
        const newCpField = cpField.cloneNode(true); 
        cpField.parentNode.replaceChild(newCpField, cpField);
        
        // On réassigne la variable au nouveau champ propre
        const activeCpField = newCpField; 

        activeCpField.addEventListener('input', function () {
            const cp = this.value.trim();

            // ❌ Si pas 5 chiffres → on nettoie
            if (!/^\d{5}$/.test(cp)) {
                cityField.value = "";
                cityField.dispatchEvent(new Event('input'));
                removeSelect();
                return;
            }

            // ⭐ Appel API
            fetch(`https://api-adresse.data.gouv.fr/search/?q=${cp}&type=municipality`)
                .then(response => response.json())
                .then(data => {
                    const results = data.features;

                    if (!results.length) {
                        cityField.value = "";
                        cityField.dispatchEvent(new Event('input'));
                        removeSelect();
                        return;
                    }

                    if (results.length === 1) {
                        removeSelect();
                        cityField.value = results[0].properties.city;
                        cityField.dispatchEvent(new Event('input'));
                        return;
                    }

                    removeSelect();

                    const select = document.createElement('select');
                    select.classList.add('form-select', 'dynamic-city', 'mt-2');

                    const optDefault = document.createElement('option');
                    optDefault.textContent = "Sélectionnez une ville";
                    optDefault.value = "";
                    select.appendChild(optDefault);

                    results.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.properties.city;
                        opt.textContent = r.properties.city;
                        select.appendChild(opt);
                    });

                    cityWrapper.appendChild(select);

                    select.addEventListener('change', function () {
                        cityField.value = this.value;
                        cityField.dispatchEvent(new Event('input'));
                    });
                })
                .catch(err => {
                    console.error("Erreur API : ", err);
                    cityField.value = "";
                    cityField.dispatchEvent(new Event('input'));
                    removeSelect();
                });
        });

        function removeSelect() {
            const oldSelect = cityWrapper.querySelector(".dynamic-city");
            if (oldSelect) oldSelect.remove();
        }
    }

    // ✅ C'est ici que la magie opère :
    // On lance le script au chargement initial
    document.addEventListener('DOMContentLoaded', initAddressApi);
    // ET on le relance à chaque navigation Turbo
    document.addEventListener('turbo:load', initAddressApi);

</script>



{% endblock %}
