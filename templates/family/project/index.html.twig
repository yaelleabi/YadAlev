{% extends 'base.html.twig' %}

{% block title %}Projets Famille - Yad Alev
{% endblock %}

{% block body %}

	<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-2 fixed-top">
		<div class="container d-flex justify-content-between align-items-center">
			<div class="d-flex align-items-center gap-3">
				<a href="{{ path('app_family_home') }}">
					<img src="{{ asset('images/LOGO.PNG') }}" alt="Logo Yad Alev" class="nav-logo">
				</a>
				<span class="fw-bold text-primary fs-5">Projets & Distributions</span>
			</div>

			<div class="d-flex align-items-center gap-4">
				<a href="{{ path('app_family_home') }}" class="nav-icon" title="Retour Accueil">
					<i class="fas fa-home"></i>
				</a>
				<a href="{{ path('app_logout') }}" class="nav-icon" title="Se déconnecter">
					<i class="fas fa-sign-out-alt"></i>
				</a>
			</div>
		</div>
	</nav>

	<div class="main-container">
		<div class="content-wrapper container flex-grow-1" style="padding-top: 100px;">

			<div class="text-center mb-5 fade-in">
				<h2 class="text-primary fw-bold">Projets Famille</h2>
				<p class="text-muted" style="animation-delay:.2s">
					Découvrez les projets disponibles et inscrivez-vous.
				</p>
			</div>

			{% if events is empty %}
				<div class="text-center py-5 fade-in">
					<div class="text-muted mb-3">
						<i class="fas fa-box-open fa-3x"></i>
					</div>
					<h4 class="fw-bold text-muted">Aucun projet disponible pour le moment.</h4>
					<p class="text-muted small">Revenez plus tard pour voir les nouvelles distributions.</p>
					<a href="{{ path('app_family_home') }}" class="btn btn-outline-primary mt-3">Retour à l'accueil</a>
				</div>
			{% else %}

				<div class="d-grid" style="grid-template-areas: 'stack'; min-height: 60vh;">

					{# LISTE DES PROJETS (Toujours affichée, mais floutée si bloquée) #}
					{# Layer 1: Background #}
						<div class="row g-4 fade-in {{ isProfileComplete == false ? 'opacity-50' : '' }}" style="grid-area: stack; z-index: 1; {{ isProfileComplete == false ? 'filter: blur(4px) grayscale(1); pointer-events: none; user-select: none;' : '' }}"> {% for event in events %}
							<div class="col-md-6 col-lg-4">
								<div class="card h-100 shadow-sm border-0 event-card">
									<div class="card-body d-flex flex-column p-4">
										<div class="d-flex justify-content-between align-items-start mb-3">
											<h5 class="fw-bold text-dark m-0">{{ event.title }}</h5>
											{% if app.user in event.assignedFamilies %}
												<span class="badge bg-success shadow-sm rounded-pill">
													<i class="fas fa-check me-1"></i>
													Inscrit</span>
											{% else %}
												<span class="badge bg-primary shadow-sm rounded-pill">Disponible</span>
											{% endif %}
										</div>

										<p class="text-muted small mb-4 flex-grow-1" style="line-height: 1.6;">
											{{ event.description|nl2br }}
										</p>

										<div class="mb-4 small text-secondary">
											<div class="d-flex align-items-center gap-2 mb-2">
												<i class="far fa-calendar-alt text-primary"></i>
												<span>Du
													<strong>{{ event.startDate|date('d/m/Y') }}</strong>
													au
													<strong>{{ event.endDate|date('d/m/Y') }}</strong>
												</span>
											</div>
											{% if event.quantity %}
												<div class="d-flex align-items-center gap-2">
													<i class="fas fa-cubes text-primary"></i>
													<span>Quantité :
														{{ event.quantity }}</span>
												</div>
											{% endif %}
										</div>

										<div class="mt-auto pt-3 border-top">
											{% set myReq = myRequests[event.id] ?? null %}

											{% if myReq %}
												<div class="text-center">
													<div class="small text-muted mb-2">Votre demande a été prise en compte</div>
													{% if myReq.status == 'PENDING' %}
														<span class="badge bg-warning text-dark w-100 py-2">
															<i class="fas fa-clock me-1"></i>
															En attente
														</span>
													{% elseif myReq.status == 'ACCEPTED' %}
														<span class="badge bg-success w-100 py-2">
															<i class="fas fa-check-circle me-1"></i>
															Validée
														</span>
													{% elseif myReq.status == 'REFUSED' %}
														<span class="badge bg-danger w-100 py-2">
															<i class="fas fa-times-circle me-1"></i>
															Refusée
														</span>
													{% endif %}
												</div>
											{% elseif app.user in event.assignedFamilies %}
												{# Cas legacy ou inscription directe hors demande #}
												<button class="btn btn-light text-success w-100 fw-bold disabled" style="opacity: 1;">
													<i class="fas fa-check-circle me-2"></i>
													Vous êtes inscrit
												</button>
											{% else %}
												<form method="post" action="{{ path('app_family_project_register', {'id': event.id}) }}">
													<button class="btn btn-warning w-100 shadow-sm text-dark fw-bold btn-hover-scale">
														Faire une demande
													</button>
												</form>
											{% endif %}
										</div>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>

					{# OVERLAY BLOQUANT SI PROFIL INCOMPLET #}
					{# Layer 2: Foreground #}
					{% if isProfileComplete == false %}
						<div class="d-flex justify-content-center align-items-center p-3" style="grid-area: stack; z-index: 10; background: rgba(255, 255, 255, 0.4);">

							<div class="text-center bg-white p-5 rounded shadow-lg border" style="max-width: 600px;">
								<i class="fas fa-exclamation-circle fa-4x text-warning mb-4"></i>
								<h3 class="fw-bold text-dark mb-3">Profil incomplet</h3>
								<p class="text-muted mb-4 fs-5">
									Veuillez compléter vos informations (Coordonnées, Adresse...) pour pouvoir accéder aux différents projets et distributions.
								</p>
								<a href="{{ path('app_family_edit', {'id': app.user.id}) }}" class="btn btn-primary btn-lg shadow-sm px-4">
									<i class="fas fa-edit me-2"></i>
									Modifier mes informations
								</a>
							</div>
						</div>
					{% endif %}

				</div>

			{% endif %}

		</div>

		<footer class="footer-custom text-center text-muted small py-4 mt-5 position-relative" style="z-index: 20;">
			<div class="footer-line mx-auto"></div>
			<p class="m-0">© 2025 Yad Alev — Tous droits réservés.</p>
		</footer>
	</div>

	<style>
		.navbar {
			border-bottom: 1px solid #e2e8f0;
		}
		.nav-logo {
			width: 48px;
		}

		.nav-icon {
			font-size: 1.4rem;
			color: #444;
			transition: 0.2s;
		}
		.nav-icon:hover {
			color: #0d6efd;
			transform: translateY(-2px);
		}

		.main-container {
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}

		.event-card {
			transition: transform 0.3s ease, box-shadow 0.3s ease;
			border-radius: 1rem;
		}
		.event-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
		}

		.btn-hover-scale {
			transition: transform 0.2s;
		}
		.btn-hover-scale:hover {
			transform: scale(1.02);
		}

		.fade-in {
			opacity: 0;
			animation: fadeSlide 0.7s ease forwards;
		}

		@keyframes fadeSlide {
			from {
				opacity: 0;
				transform: translateY(25px);
			}
			to {
				opacity: 1;
				transform: none;
			}
		}

		.footer-line {
			width: 85%;
			height: 1px;
			background: #d0d7e0;
		}
	</style>

{% endblock %}
